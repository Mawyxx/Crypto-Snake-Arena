# Ручной запуск: начисление 500 USDT пользователю 7175104609 на ПРОД
# Actions → Add balance (500 USDT) → Run workflow
#
# Настрой: Settings → Secrets → ADD_BALANCE_SECRET (тот же токен, что в .env на сервере)
# И на сервере в .env: ADD_BALANCE_SECRET=твой_секретный_токен

name: Add balance (500 USDT)

on:
  workflow_dispatch:

jobs:
  addbalance:
    runs-on: ubuntu-latest
    steps:
      - name: Add 500 USDT via API
        run: |
          API_URL="${API_URL:-https://arrenasnake.net}"
          TOKEN="${{ secrets.ADD_BALANCE_SECRET }}"
          if [ -z "$TOKEN" ]; then
            echo "ERROR: ADD_BALANCE_SECRET not set in repository secrets"
            exit 1
          fi
          resp=$(curl -s -w "\n%{http_code}" -X POST \
            -H "X-Add-Balance-Token: $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"tg_id":7175104609,"amount":500}' \
            "$API_URL/api/internal/add-balance")
          code=$(echo "$resp" | tail -n1)
          body=$(echo "$resp" | sed '$d')
          echo "$body"
          if [ "$code" != "200" ]; then
            echo "HTTP $code"
            exit 1
          fi
          echo "OK: 500 USDT credited"
